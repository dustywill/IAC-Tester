<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IAC Valve Tester - PREVIEW</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #0a0e14;
      --bg-secondary: #141a22;
      --bg-tertiary: #1c242e;
      --accent-orange: #e85d04;
      --accent-orange-dim: #9d3c02;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --text-primary: #e6e6e6;
      --text-secondary: #8b949e;
      --text-dim: #484f58;
      --border-color: #2d3640;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', Courier, monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }
    
    .preview-banner {
      background: var(--accent-orange);
      color: var(--bg-primary);
      text-align: center;
      padding: 10px;
      font-weight: bold;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--accent-orange);
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--accent-orange);
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 5px;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .panel-title {
      font-size: 1rem;
      color: var(--accent-orange);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .btn {
      background: var(--bg-tertiary);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 15px 25px;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.15s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn:hover {
      border-color: var(--accent-orange);
      background: var(--bg-secondary);
    }
    
    .btn:active, .btn.active {
      background: var(--accent-orange);
      border-color: var(--accent-orange);
      color: var(--bg-primary);
    }
    
    .btn-extend { border-left: 4px solid var(--accent-green); }
    .btn-retract { border-left: 4px solid var(--accent-red); }
    .btn-stop { border-left: 4px solid var(--accent-orange); }
    
    .settings-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .settings-row label {
      flex: 0 0 140px;
      color: var(--text-secondary);
    }
    
    .settings-row input {
      flex: 1;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px;
      font-family: inherit;
      font-size: 1rem;
      border-radius: 4px;
      max-width: 150px;
    }
    
    .settings-row input:focus {
      outline: none;
      border-color: var(--accent-orange);
    }
    
    .settings-row .unit {
      margin-left: 10px;
      color: var(--text-dim);
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      text-align: center;
    }
    
    .signal-indicator {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .signal-indicator .label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    
    .signal-indicator .led {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin: 0 auto;
      background: var(--text-dim);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
      transition: all 0.1s ease;
    }
    
    .signal-indicator .led.on {
      background: var(--accent-green);
      box-shadow: 0 0 15px var(--accent-green), inset 0 2px 4px rgba(255,255,255,0.2);
    }
    
    .log-container {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      height: 250px;
      overflow-y: auto;
      padding: 10px;
      font-size: 0.8rem;
    }
    
    .log-entry {
      display: flex;
      gap: 15px;
      padding: 4px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .log-entry .time {
      color: var(--text-dim);
      flex: 0 0 80px;
    }
    
    .log-entry .signals {
      color: var(--text-secondary);
      flex: 0 0 100px;
    }
    
    .log-entry .event {
      color: var(--text-primary);
    }
    
    .log-entry.iac-active {
      background: rgba(232, 93, 4, 0.1);
    }
    
    .log-entry.iac-active .event {
      color: var(--accent-orange);
    }
    
    .log-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .log-controls .btn {
      padding: 10px 20px;
      font-size: 0.85rem;
    }
    
    .motor-status {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-top: 15px;
    }
    
    .motor-status .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-dim);
    }
    
    .motor-status .indicator.enabled {
      background: var(--accent-green);
      box-shadow: 0 0 10px var(--accent-green);
    }
    
    .motor-status .indicator.moving {
      background: var(--accent-orange);
      box-shadow: 0 0 10px var(--accent-orange);
      animation: pulse 0.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .direction-display {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }
    
    .direction-box {
      text-align: center;
      padding: 15px 30px;
      border-radius: 6px;
      border: 2px solid var(--border-color);
      min-width: 150px;
    }
    
    .direction-box .label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .direction-box .value {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--text-dim);
    }
    
    .direction-box .value.extend {
      color: var(--accent-green);
    }
    
    .direction-box .value.retract {
      color: var(--accent-red);
    }
    
    .direction-box .value.idle {
      color: var(--text-dim);
    }
    
    .direction-box.you {
      border-color: var(--accent-orange);
    }
    
    .direction-box.pcm {
      border-color: #3b82f6;
    }
    
    .relationship-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .relationship-indicator.opposing {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid var(--accent-green);
      color: var(--accent-green);
    }
    
    .relationship-indicator.same {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid var(--accent-red);
      color: var(--accent-red);
    }
    
    .relationship-indicator.neutral {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .chart-container {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .chart-canvas {
      width: 100%;
      height: 250px;
    }
    
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    
    .chart-legend .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chart-legend .color-box {
      width: 16px;
      height: 4px;
      border-radius: 2px;
    }
    
    .chart-legend .you-color {
      background: var(--accent-orange);
    }
    
    .chart-legend .pcm-color {
      background: #3b82f6;
    }
    
    .chart-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
    
    .chart-stat {
      text-align: center;
    }
    
    .chart-stat .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .chart-stat .stat-value {
      font-size: 1.1rem;
      font-weight: bold;
    }
    
    .chart-stat .stat-value.positive {
      color: var(--accent-green);
    }
    
    .chart-stat .stat-value.negative {
      color: var(--accent-red);
    }
    
    .chart-stat .stat-value.neutral {
      color: var(--text-primary);
    }
    
    .quick-steps {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .quick-steps .btn {
      padding: 10px 15px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="preview-banner">
      ⚠ PREVIEW MODE - Mock data, no ESP32 connection ⚠
    </div>
    
    <header>
      <h1>IAC Valve Tester</h1>
      <div class="subtitle">1997 Jeep Wrangler 2.5L</div>
    </header>
    
    <!-- Motor Control Panel -->
    <div class="panel">
      <div class="panel-title">Motor Control</div>
      <div class="control-grid">
        <button class="btn btn-extend" id="btnExtend" onmousedown="startMove('extend')" onmouseup="stopMove()" onmouseleave="stopMove()">
          ▲ Extend
        </button>
        <button class="btn btn-retract" id="btnRetract" onmousedown="startMove('retract')" onmouseup="stopMove()" onmouseleave="stopMove()">
          ▼ Retract
        </button>
        <button class="btn btn-stop" onclick="emergencyStop()">
          ■ Stop
        </button>
      </div>
      
      <div class="quick-steps">
        <span style="color: var(--text-secondary); line-height: 38px;">Quick:</span>
        <button class="btn" onclick="moveSteps(10, 1)">+10</button>
        <button class="btn" onclick="moveSteps(50, 1)">+50</button>
        <button class="btn" onclick="moveSteps(100, 1)">+100</button>
        <button class="btn" onclick="moveSteps(10, -1)">-10</button>
        <button class="btn" onclick="moveSteps(50, -1)">-50</button>
        <button class="btn" onclick="moveSteps(100, -1)">-100</button>
      </div>
      
      <div class="motor-status">
        <div class="indicator" id="motorIndicator"></div>
        <span id="motorStatusText">Motor: Idle</span>
      </div>
    </div>
    
    <!-- Settings Panel -->
    <div class="panel">
      <div class="panel-title">Stepper Settings</div>
      <div class="settings-row">
        <label>Step Delay:</label>
        <input type="number" id="stepDelay" value="20" min="1" max="500" onchange="updateSettings()">
        <span class="unit">ms</span>
      </div>
      <div class="settings-row">
        <label>Frequency:</label>
        <span id="frequencyDisplay" style="color: var(--text-primary);">50.0 Hz</span>
      </div>
    </div>
    
    <!-- PCM Signal Monitor -->
    <div class="panel">
      <div class="panel-title">PCM Signal Monitor</div>
      <div class="status-grid">
        <div class="signal-indicator">
          <div class="label">A1</div>
          <div class="led" id="ledA1"></div>
        </div>
        <div class="signal-indicator">
          <div class="label">A2</div>
          <div class="led" id="ledA2"></div>
        </div>
        <div class="signal-indicator">
          <div class="label">B1</div>
          <div class="led" id="ledB1"></div>
        </div>
        <div class="signal-indicator">
          <div class="label">B2</div>
          <div class="led" id="ledB2"></div>
        </div>
      </div>
      
      <div class="direction-display">
        <div class="direction-box you">
          <div class="label">You Command</div>
          <div class="value idle" id="yourDirection">IDLE</div>
        </div>
        <div class="direction-box pcm">
          <div class="label">PCM Response</div>
          <div class="value idle" id="pcmDirection">IDLE</div>
        </div>
      </div>
      
      <div class="relationship-indicator neutral" id="relationshipIndicator">
        Waiting for activity...
      </div>
      
      <div class="chart-container">
        <canvas id="stepChart" class="chart-canvas"></canvas>
        <div class="chart-legend">
          <div class="legend-item">
            <div class="color-box you-color"></div>
            <span>Your Commands</span>
          </div>
          <div class="legend-item">
            <div class="color-box pcm-color"></div>
            <span>PCM Response</span>
          </div>
        </div>
        <div class="chart-stats">
          <div class="chart-stat">
            <div class="stat-label">Your Position</div>
            <div class="stat-value neutral" id="statYouPos">0</div>
          </div>
          <div class="chart-stat">
            <div class="stat-label">PCM Position</div>
            <div class="stat-value neutral" id="statPcmPos">0</div>
          </div>
          <div class="chart-stat">
            <div class="stat-label">Net Difference</div>
            <div class="stat-value neutral" id="statDiff">0</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Signal Log Panel -->
    <div class="panel">
      <div class="panel-title">Signal Log</div>
      <div class="log-container" id="logContainer">
        <!-- Mock log entries will be added here -->
      </div>
      <div class="log-controls">
        <button class="btn" onclick="clearLog()">Clear Log</button>
        <button class="btn" onclick="downloadLog()">Download CSV</button>
        <button class="btn" id="btnPauseLog" onclick="toggleLogPause()">Pause</button>
        <button class="btn" onclick="resetAll()" style="border-left: 4px solid var(--accent-green);">Reset Chart</button>
        <button class="btn" onclick="simulateSignals()" style="border-left: 4px solid #3b82f6;">Simulate PCM</button>
      </div>
    </div>
  </div>
  
  <script>
    // =============================================
    // PREVIEW MODE - Simulated behavior for testing
    // =============================================
    
    let isLogPaused = false;
    let logData = [];
    let simulationInterval = null;
    let isMoving = false;
    let moveDirection = 0;
    
    // Mock PCM state
    let pcmState = { a1: false, a2: false, b1: false, b2: false };
    let stepIndex = 0;
    let pcmDirection = 0;  // Simulated PCM direction
    
    // Step position tracking for chart
    let youStepPosition = 0;
    let pcmStepPosition = 0;
    let stepChart = null;
    const MAX_CHART_POINTS = 200;
    let chartStartTime = Date.now();
    
    // Step sequence for simulation
    const stepSequence = [
      { a1: true,  a2: false, b1: true,  b2: false },
      { a1: false, a2: true,  b1: true,  b2: false },
      { a1: false, a2: true,  b1: false, b2: true  },
      { a1: true,  a2: false, b1: false, b2: true  }
    ];
    
    // Initialize with some mock log entries
    document.addEventListener('DOMContentLoaded', function() {
      updateSettings();
      initChart();
      addMockLogEntries();
    });
    
    // Chart initialization
    function initChart() {
      const ctx = document.getElementById('stepChart').getContext('2d');
      
      stepChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Your Commands',
              data: [],
              borderColor: '#e85d04',
              backgroundColor: 'rgba(232, 93, 4, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1,
              pointRadius: 0
            },
            {
              label: 'PCM Response',
              data: [],
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.1,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            x: {
              type: 'linear',
              title: {
                display: true,
                text: 'Time (seconds)',
                color: '#8b949e'
              },
              ticks: { color: '#8b949e' },
              grid: { color: '#2d3640' }
            },
            y: {
              title: {
                display: true,
                text: 'Step Position',
                color: '#8b949e'
              },
              ticks: { color: '#8b949e' },
              grid: { color: '#2d3640', drawZero: true },
              suggestedMin: -50,
              suggestedMax: 50
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
      
      // Add initial zero point
      addChartPoint(0, 0);
    }
    
    function addChartPoint(youPos, pcmPos) {
      const timeSeconds = ((Date.now() - chartStartTime) / 1000).toFixed(1);
      
      stepChart.data.labels.push(parseFloat(timeSeconds));
      stepChart.data.datasets[0].data.push({ x: parseFloat(timeSeconds), y: youPos });
      stepChart.data.datasets[1].data.push({ x: parseFloat(timeSeconds), y: pcmPos });
      
      // Limit data points
      if (stepChart.data.labels.length > MAX_CHART_POINTS) {
        stepChart.data.labels.shift();
        stepChart.data.datasets[0].data.shift();
        stepChart.data.datasets[1].data.shift();
      }
      
      // Auto-scale Y axis
      const allYValues = [...stepChart.data.datasets[0].data.map(p => p.y), 
                          ...stepChart.data.datasets[1].data.map(p => p.y)];
      const maxY = Math.max(...allYValues, 10);
      const minY = Math.min(...allYValues, -10);
      const padding = Math.max(10, Math.abs(maxY - minY) * 0.1);
      stepChart.options.scales.y.suggestedMax = maxY + padding;
      stepChart.options.scales.y.suggestedMin = minY - padding;
      
      stepChart.update('none');
      updateChartStats();
    }
    
    function updateChartStats() {
      const youEl = document.getElementById('statYouPos');
      const pcmEl = document.getElementById('statPcmPos');
      const diffEl = document.getElementById('statDiff');
      
      youEl.textContent = (youStepPosition >= 0 ? '+' : '') + youStepPosition;
      youEl.className = 'stat-value ' + (youStepPosition > 0 ? 'positive' : youStepPosition < 0 ? 'negative' : 'neutral');
      
      pcmEl.textContent = (pcmStepPosition >= 0 ? '+' : '') + pcmStepPosition;
      pcmEl.className = 'stat-value ' + (pcmStepPosition > 0 ? 'positive' : pcmStepPosition < 0 ? 'negative' : 'neutral');
      
      const diff = youStepPosition + pcmStepPosition;
      diffEl.textContent = (diff >= 0 ? '+' : '') + diff;
      diffEl.className = 'stat-value ' + (diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral');
    }
    
    function resetChart() {
      youStepPosition = 0;
      pcmStepPosition = 0;
      chartStartTime = Date.now();
      stepChart.data.labels = [];
      stepChart.data.datasets[0].data = [];
      stepChart.data.datasets[1].data = [];
      stepChart.update('none');
      addChartPoint(0, 0);
    }
    
    function resetAll() {
      resetChart();
      clearLog();
      pcmDirection = 0;
      updateDirectionDisplay();
    }
    
    function addMockLogEntries() {
      const mockEntries = [
        { ts: Date.now() - 5000, a1: 1, a2: 0, b1: 1, b2: 0, iac: false },
        { ts: Date.now() - 4500, a1: 0, a2: 1, b1: 1, b2: 0, iac: false },
        { ts: Date.now() - 4000, a1: 0, a2: 1, b1: 0, b2: 1, iac: true },
        { ts: Date.now() - 3500, a1: 1, a2: 0, b1: 0, b2: 1, iac: true },
        { ts: Date.now() - 3000, a1: 1, a2: 0, b1: 1, b2: 0, iac: false },
      ];
      appendLogEntries(mockEntries);
    }
    
    function updateSignalLeds(pcm) {
      document.getElementById('ledA1').className = 'led' + (pcm.a1 ? ' on' : '');
      document.getElementById('ledA2').className = 'led' + (pcm.a2 ? ' on' : '');
      document.getElementById('ledB1').className = 'led' + (pcm.b1 ? ' on' : '');
      document.getElementById('ledB2').className = 'led' + (pcm.b2 ? ' on' : '');
    }
    
    function updateMotorStatus() {
      const indicator = document.getElementById('motorIndicator');
      const text = document.getElementById('motorStatusText');
      
      if (isMoving) {
        indicator.className = 'indicator moving';
        text.textContent = 'Motor: Moving (' + (moveDirection > 0 ? 'Extend' : 'Retract') + ')';
      } else {
        indicator.className = 'indicator';
        text.textContent = 'Motor: Idle';
      }
    }
    
    function updateDirectionDisplay() {
      const yourDirEl = document.getElementById('yourDirection');
      const pcmDirEl = document.getElementById('pcmDirection');
      const relEl = document.getElementById('relationshipIndicator');
      
      // Your direction
      if (isMoving) {
        if (moveDirection > 0) {
          yourDirEl.textContent = 'EXTEND';
          yourDirEl.className = 'value extend';
        } else {
          yourDirEl.textContent = 'RETRACT';
          yourDirEl.className = 'value retract';
        }
      } else {
        yourDirEl.textContent = 'IDLE';
        yourDirEl.className = 'value idle';
      }
      
      // PCM direction
      if (pcmDirection > 0) {
        pcmDirEl.textContent = 'EXTEND';
        pcmDirEl.className = 'value extend';
      } else if (pcmDirection < 0) {
        pcmDirEl.textContent = 'RETRACT';
        pcmDirEl.className = 'value retract';
      } else {
        pcmDirEl.textContent = 'IDLE';
        pcmDirEl.className = 'value idle';
      }
      
      // Relationship indicator
      const youDir = isMoving ? moveDirection : 0;
      if (youDir === 0 && pcmDirection === 0) {
        relEl.textContent = 'Waiting for activity...';
        relEl.className = 'relationship-indicator neutral';
      } else if (youDir === 0) {
        relEl.textContent = 'PCM is adjusting (you idle)';
        relEl.className = 'relationship-indicator neutral';
      } else if (pcmDirection === 0) {
        relEl.textContent = 'PCM not responding yet...';
        relEl.className = 'relationship-indicator neutral';
      } else if (youDir !== pcmDirection) {
        relEl.textContent = '✓ PCM OPPOSING - Feedback loop working!';
        relEl.className = 'relationship-indicator opposing';
      } else {
        relEl.textContent = '⚠ PCM SAME DIRECTION - Unexpected!';
        relEl.className = 'relationship-indicator same';
      }
    }
    
    function appendLogEntries(entries) {
      const container = document.getElementById('logContainer');
      
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'log-entry' + (entry.iac ? ' iac-active' : '');
        
        const time = new Date(entry.ts).toLocaleTimeString();
        const signals = (entry.a1?'1':'0') + (entry.a2?'1':'0') + (entry.b1?'1':'0') + (entry.b2?'1':'0');
        const event = entry.iac ? 'IAC Active' : 'PCM Change';
        
        div.innerHTML = 
          '<span class="time">' + time + '</span>' +
          '<span class="signals">' + signals + '</span>' +
          '<span class="event">' + event + '</span>';
        
        container.appendChild(div);
        logData.push(entry);
      });
      
      container.scrollTop = container.scrollHeight;
      
      while (container.children.length > 200) {
        container.removeChild(container.firstChild);
      }
    }
    
    // Motor control (preview simulation)
    let yourStepInterval = null;
    
    function startMove(direction) {
      isMoving = true;
      moveDirection = direction === 'extend' ? 1 : -1;
      document.getElementById(direction === 'extend' ? 'btnExtend' : 'btnRetract').classList.add('active');
      updateMotorStatus();
      updateDirectionDisplay();
      console.log('[PREVIEW] Would send: POST /api/move?continuous=1&direction=' + moveDirection);
      
      // Start incrementing your step position
      yourStepInterval = setInterval(() => {
        youStepPosition += moveDirection;
        addChartPoint(youStepPosition, pcmStepPosition);
      }, parseInt(document.getElementById('stepDelay').value) || 50);
      
      // Simulate PCM opposing after a short delay (like real feedback)
      setTimeout(() => {
        if (isMoving) {
          pcmDirection = -moveDirection;  // PCM opposes!
          startPcmSimulation(pcmDirection);
          updateDirectionDisplay();
        }
      }, 300);
    }
    
    function stopMove() {
      isMoving = false;
      moveDirection = 0;
      document.getElementById('btnExtend').classList.remove('active');
      document.getElementById('btnRetract').classList.remove('active');
      updateMotorStatus();
      updateDirectionDisplay();
      console.log('[PREVIEW] Would send: POST /api/stop');
      
      // Stop your step interval
      if (yourStepInterval) {
        clearInterval(yourStepInterval);
        yourStepInterval = null;
      }
      
      // PCM goes idle after you stop (with delay)
      setTimeout(() => {
        if (!isMoving) {
          pcmDirection = 0;
          stopPcmSimulation();
          updateDirectionDisplay();
        }
      }, 500);
    }
    
    function moveSteps(steps, direction) {
      console.log('[PREVIEW] Would send: POST /api/move?steps=' + steps + '&direction=' + direction);
      
      // Simulate the movement with a brief indicator flash
      isMoving = true;
      moveDirection = direction;
      updateMotorStatus();
      updateDirectionDisplay();
      
      // Increment your position immediately
      youStepPosition += (steps * direction);
      addChartPoint(youStepPosition, pcmStepPosition);
      
      // Simulate PCM opposing
      setTimeout(() => {
        pcmDirection = -direction;
        startPcmSimulation(pcmDirection);
        updateDirectionDisplay();
      }, 200);
      
      setTimeout(() => {
        isMoving = false;
        moveDirection = 0;
        updateMotorStatus();
        updateDirectionDisplay();
        
        // PCM continues briefly then stops
        setTimeout(() => {
          pcmDirection = 0;
          stopPcmSimulation();
          updateDirectionDisplay();
        }, 300);
      }, steps * 20);
    }
    
    function emergencyStop() {
      stopMove();
      pcmDirection = 0;
      stopPcmSimulation();
      updateDirectionDisplay();
      console.log('[PREVIEW] Would send: POST /api/stop?emergency=1');
    }
    
    // Settings
    function updateSettings() {
      const delay = document.getElementById('stepDelay').value;
      const freq = (1000 / delay).toFixed(1);
      document.getElementById('frequencyDisplay').textContent = freq + ' Hz';
      console.log('[PREVIEW] Would send: POST /api/settings?delay=' + delay);
    }
    
    // Log controls
    function clearLog() {
      document.getElementById('logContainer').innerHTML = '';
      logData = [];
      console.log('[PREVIEW] Would send: POST /api/log/clear');
    }
    
    function toggleLogPause() {
      isLogPaused = !isLogPaused;
      document.getElementById('btnPauseLog').textContent = isLogPaused ? 'Resume' : 'Pause';
      document.getElementById('btnPauseLog').classList.toggle('active', isLogPaused);
    }
    
    function downloadLog() {
      let csv = 'Timestamp,A1,A2,B1,B2,IAC_Active\n';
      logData.forEach(entry => {
        csv += entry.ts + ',' + 
               (entry.a1?1:0) + ',' + 
               (entry.a2?1:0) + ',' + 
               (entry.b1?1:0) + ',' + 
               (entry.b2?1:0) + ',' + 
               (entry.iac?1:0) + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'iac_log_' + Date.now() + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // PCM Simulation helpers
    function startPcmSimulation(direction) {
      if (simulationInterval) return;  // Already running
      
      simulationInterval = setInterval(() => {
        // Advance step in the correct direction
        if (direction > 0) {
          stepIndex = (stepIndex + 1) % 4;  // Forward = extend
          pcmStepPosition += 1;
        } else {
          stepIndex = (stepIndex + 3) % 4;  // Backward = retract
          pcmStepPosition -= 1;
        }
        pcmState = stepSequence[stepIndex];
        
        // Update LEDs
        updateSignalLeds(pcmState);
        
        // Update chart
        addChartPoint(youStepPosition, pcmStepPosition);
        
        // Add log entry if not paused
        if (!isLogPaused) {
          appendLogEntries([{
            ts: Date.now(),
            a1: pcmState.a1 ? 1 : 0,
            a2: pcmState.a2 ? 1 : 0,
            b1: pcmState.b1 ? 1 : 0,
            b2: pcmState.b2 ? 1 : 0,
            iac: isMoving
          }]);
        }
      }, parseInt(document.getElementById('stepDelay').value) || 50);
    }
    
    function stopPcmSimulation() {
      if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
      }
    }
    
    // Manual simulate button (toggles independent PCM activity)
    function simulateSignals() {
      if (simulationInterval) {
        stopPcmSimulation();
        pcmDirection = 0;
        updateDirectionDisplay();
        console.log('[PREVIEW] PCM simulation stopped');
        return;
      }
      
      console.log('[PREVIEW] PCM simulation started (extending)');
      pcmDirection = 1;  // Default to extend when manually triggered
      updateDirectionDisplay();
      startPcmSimulation(1);
    }
  </script>
</body>
</html>
