<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1350 950" width="1350" height="950">
  <defs>
    <style>
      .title { font: bold 24px monospace; fill: #e85d04; }
      .subtitle { font: 14px monospace; fill: #8b949e; }
      .component-label { font: bold 14px monospace; fill: #22c55e; }
      .pin-label { font: 11px monospace; fill: #e6e6e6; }
      .note { font: 11px monospace; fill: #8b949e; }
      .wire-12v { stroke: #ef4444; stroke-width: 2; fill: none; }
      .wire-5v { stroke: #f59e0b; stroke-width: 2; fill: none; }
      .wire-3v3 { stroke: #a855f7; stroke-width: 2; fill: none; }
      .wire-gnd { stroke: #6b7280; stroke-width: 2; fill: none; }
      .wire-signal { stroke: #3b82f6; stroke-width: 1.5; fill: none; }
      .wire-motor { stroke: #22c55e; stroke-width: 2; fill: none; }
      .wire-pcm { stroke: #f97316; stroke-width: 1.5; fill: none; }
      .component-box { fill: #1a1f26; stroke: #374151; stroke-width: 2; rx: 6; }
      .component-box-highlight { fill: #1a1f26; stroke: #e85d04; stroke-width: 2; rx: 6; }
      .pin-dot { fill: #d1d5db; }
      .gnd-dot { fill: #22c55e; }
      .legend-box { fill: #141a22; stroke: #374151; stroke-width: 1; rx: 4; }
    </style>
  </defs>
  
  <!-- Background -->
  <rect width="100%" height="100%" fill="#0d1117"/>
  
  <!-- Title -->
  <text x="550" y="35" text-anchor="middle" class="title">IAC VALVE TESTER - WIRING DIAGRAM</text>
  <text x="550" y="55" text-anchor="middle" class="subtitle">1997 Jeep Wrangler 2.5L &#8226; ESP32-S3 + TB6612FNG + PC817</text>

  <!-- ===== WIRE LEGEND ===== -->
  <g transform="translate(1150, 75)">
    <rect x="-10" y="-20" width="170" height="175" class="legend-box"/>
    <text x="0" y="0" class="component-label">WIRE LEGEND</text>
    <line x1="0" y1="20" x2="40" y2="20" class="wire-12v"/>
    <text x="50" y="24" class="pin-label">12V Power</text>
    <line x1="0" y1="42" x2="40" y2="42" class="wire-5v"/>
    <text x="50" y="46" class="pin-label">5V Power</text>
    <line x1="0" y1="64" x2="40" y2="64" class="wire-3v3"/>
    <text x="50" y="68" class="pin-label">3.3V Power</text>
    <line x1="0" y1="86" x2="40" y2="86" class="wire-gnd"/>
    <text x="50" y="90" class="pin-label">Ground</text>
    <line x1="0" y1="108" x2="40" y2="108" class="wire-signal"/>
    <text x="50" y="112" class="pin-label">Signal</text>
    <line x1="0" y1="130" x2="40" y2="130" class="wire-motor"/>
    <text x="50" y="134" class="pin-label">Motor Out</text>
    <line x1="0" y1="152" x2="40" y2="152" class="wire-pcm"/>
    <text x="50" y="156" class="pin-label">PCM Input</text>
  </g>

  <!-- ===== 12V CAR BATTERY ===== -->
  <g transform="translate(40, 120)">
    <rect x="0" y="0" width="110" height="70" class="component-box-highlight"/>
    <text x="55" y="22" text-anchor="middle" class="component-label">12V CAR</text>
    <text x="55" y="40" text-anchor="middle" class="component-label">BATTERY</text>
    <text x="55" y="58" text-anchor="middle" class="note">(via fused tap)</text>
    <circle cx="110" cy="25" r="4" class="pin-dot"/>
    <text x="118" y="29" class="pin-label">+12V</text>
    <circle cx="110" cy="50" r="4" class="pin-dot"/>
    <text x="118" y="54" class="pin-label">GND</text>
  </g>

  <!-- ===== LM2596 BUCK CONVERTER ===== -->
  <g transform="translate(230, 105)">
    <rect x="0" y="0" width="120" height="85" class="component-box"/>
    <text x="60" y="22" text-anchor="middle" class="component-label">LM2596</text>
    <text x="60" y="40" text-anchor="middle" class="component-label">BUCK CONV</text>
    <text x="60" y="58" text-anchor="middle" class="note">12V &#8594; 5V</text>
    <circle cx="0" cy="25" r="4" class="pin-dot"/>
    <text x="-28" y="29" class="pin-label">IN+</text>
    <circle cx="0" cy="60" r="4" class="pin-dot"/>
    <text x="-28" y="64" class="pin-label">IN-</text>
    <circle cx="120" cy="25" r="4" class="pin-dot"/>
    <text x="128" y="29" class="pin-label">OUT+ (5V)</text>
    <circle cx="120" cy="60" r="4" class="pin-dot"/>
    <text x="128" y="64" class="pin-label">OUT-</text>
  </g>

  <!-- Wire: Battery to Buck -->
  <path d="M 150 145 L 190 145 L 190 130 L 230 130" class="wire-12v"/>
  <path d="M 150 170 L 200 170 L 200 165 L 230 165" class="wire-gnd"/>

  <!-- ===== ESP32-S3 ===== -->
  <g transform="translate(440, 85)">
    <rect x="0" y="0" width="180" height="280" class="component-box-highlight"/>
    <text x="90" y="25" text-anchor="middle" class="component-label">ESP32-S3</text>
    <text x="90" y="45" text-anchor="middle" class="component-label">WROOM-1</text>
    
    <!-- Left side - Power -->
    <circle cx="0" cy="75" r="4" class="pin-dot"/>
    <text x="8" y="79" class="pin-label">5V/VIN</text>
    <circle cx="0" cy="100" r="4" class="pin-dot"/>
    <text x="8" y="104" class="pin-label">GND</text>
    <circle cx="0" cy="125" r="4" class="pin-dot"/>
    <text x="8" y="129" class="pin-label">3.3V</text>
    
    <!-- Right side - Motor control (updated pins) -->
    <text x="95" y="75" class="pin-label">GPIO7 (AIN1)</text>
    <circle cx="180" cy="71" r="4" class="pin-dot"/>
    
    <text x="90" y="95" class="pin-label">GPIO15 (AIN2)</text>
    <circle cx="180" cy="91" r="4" class="pin-dot"/>
    
    <text x="95" y="115" class="pin-label">GPIO6 (BIN1)</text>
    <circle cx="180" cy="111" r="4" class="pin-dot"/>
    
    <text x="95" y="135" class="pin-label">GPIO5 (BIN2)</text>
    <circle cx="180" cy="131" r="4" class="pin-dot"/>
    
    <text x="90" y="155" class="pin-label">GPIO18 (STBY)</text>
    <circle cx="180" cy="151" r="4" class="pin-dot"/>
    
    <!-- Right side - PCM monitoring (updated pins) -->
    <text x="80" y="195" class="pin-label">GPIO16 (PCM_A1)</text>
    <circle cx="180" cy="191" r="4" class="pin-dot"/>
    
    <text x="80" y="215" class="pin-label">GPIO17 (PCM_A2)</text>
    <circle cx="180" cy="211" r="4" class="pin-dot"/>
    
    <text x="85" y="235" class="pin-label">GPIO8 (PCM_B1)</text>
    <circle cx="180" cy="231" r="4" class="pin-dot"/>
    
    <text x="85" y="255" class="pin-label">GPIO3 (PCM_B2)</text>
    <circle cx="180" cy="251" r="4" class="pin-dot"/>
  </g>

  <!-- Wire: Buck to ESP32 -->
  <path d="M 350 130 L 400 130 L 400 160 L 440 160" class="wire-5v"/>
  <path d="M 350 165 L 410 165 L 410 185 L 440 185" class="wire-gnd"/>

  <!-- ===== TB6612FNG ===== -->
  <g transform="translate(750, 85)">
    <rect x="0" y="0" width="150" height="240" class="component-box"/>
    <text x="75" y="22" text-anchor="middle" class="component-label">TB6612FNG</text>
    <text x="75" y="42" text-anchor="middle" class="component-label">MOTOR DRIVER</text>
    
    <!-- Left side - Power & Control -->
    <circle cx="0" cy="70" r="4" class="pin-dot"/>
    <text x="8" y="74" class="pin-label">VM (12V)</text>
    
    <circle cx="0" cy="90" r="4" class="pin-dot"/>
    <text x="8" y="94" class="pin-label">VCC (3.3V)</text>
    
    <circle cx="0" cy="110" r="4" class="pin-dot"/>
    <text x="8" y="114" class="pin-label">GND</text>
    
    <circle cx="0" cy="135" r="4" class="pin-dot"/>
    <text x="8" y="139" class="pin-label">AIN1</text>
    
    <circle cx="0" cy="150" r="4" class="pin-dot"/>
    <text x="8" y="154" class="pin-label">AIN2</text>
    
    <circle cx="0" cy="165" r="4" class="pin-dot"/>
    <text x="8" y="169" class="pin-label">BIN1</text>
    
    <circle cx="0" cy="180" r="4" class="pin-dot"/>
    <text x="8" y="184" class="pin-label">BIN2</text>
    
    <!-- PWM pins (NEW) -->
    <circle cx="0" cy="200" r="4" class="pin-dot"/>
    <text x="8" y="204" class="pin-label">PWMA (3.3V)</text>
    
    <circle cx="0" cy="215" r="4" class="pin-dot"/>
    <text x="8" y="219" class="pin-label">PWMB (3.3V)</text>
    
    <!-- Bottom - STBY -->
    <circle cx="75" cy="240" r="4" class="pin-dot"/>
    <text x="90" y="244" class="pin-label">STBY</text>
    
    <!-- Right side - Motor outputs -->
    <circle cx="150" cy="100" r="4" class="pin-dot"/>
    <text x="105" y="104" class="pin-label">AO1</text>
    
    <circle cx="150" cy="120" r="4" class="pin-dot"/>
    <text x="105" y="124" class="pin-label">AO2</text>
    
    <circle cx="150" cy="150" r="4" class="pin-dot"/>
    <text x="105" y="154" class="pin-label">BO1</text>
    
    <circle cx="150" cy="170" r="4" class="pin-dot"/>
    <text x="105" y="174" class="pin-label">BO2</text>
  </g>

  <!-- ===== 10uF CAPACITOR near TB6612 ===== -->
  <g transform="translate(705, 130)">
    <!-- Capacitor symbol (two parallel lines) -->
    <line x1="0" y1="0" x2="0" y2="30" class="wire-12v"/>
    <line x1="-8" y1="30" x2="8" y2="30" stroke="#d1d5db" stroke-width="3"/>
    <line x1="-8" y1="36" x2="8" y2="36" stroke="#d1d5db" stroke-width="3"/>
    <line x1="0" y1="36" x2="0" y2="65" class="wire-gnd"/>
    <text x="-35" y="38" class="note">10uF</text>
    <text x="12" y="28" class="pin-label">+</text>
  </g>

  <!-- ===== IAC VALVE ===== -->
  <g transform="translate(1000, 100)">
    <rect x="0" y="0" width="120" height="180" class="component-box-highlight"/>
    <text x="60" y="22" text-anchor="middle" class="component-label">IAC VALVE</text>
    <text x="60" y="42" text-anchor="middle" class="note">(Bipolar Stepper)</text>
    
    <circle cx="0" cy="85" r="4" class="pin-dot"/>
    <text x="10" y="89" class="pin-label">A1 (Coil A+)</text>
    
    <circle cx="0" cy="105" r="4" class="pin-dot"/>
    <text x="10" y="109" class="pin-label">A2 (Coil A-)</text>
    
    <circle cx="0" cy="140" r="4" class="pin-dot"/>
    <text x="10" y="144" class="pin-label">B1 (Coil B+)</text>
    
    <circle cx="0" cy="160" r="4" class="pin-dot"/>
    <text x="10" y="164" class="pin-label">B2 (Coil B-)</text>
  </g>

  <!-- 12V to TB6612 VM with capacitor in parallel -->
  <path d="M 150 145 L 190 145 L 190 75 L 720 75 L 720 155 L 750 155" class="wire-12v"/>
  <!-- 12V branch to capacitor + -->
  <path d="M 705 75 L 705 130" class="wire-12v"/>
  <!-- Capacitor ground connection to ground bus -->
  <path d="M 705 195 L 705 850" class="wire-gnd"/>
  <!-- Ground dot at capacitor junction -->
  <circle cx="705" cy="850" r="6" class="gnd-dot"/>
  
  <!-- 3.3V from ESP32 to TB6612 VCC, PWMA, PWMB -->
  <path d="M 440 210 L 420 210 L 420 175 L 750 175" class="wire-3v3"/>
  <!-- PWMA connection to 3.3V -->
  <path d="M 420 175 L 420 285 L 750 285" class="wire-3v3"/>
  <!-- PWMB connection to 3.3V -->
  <path d="M 420 285 L 420 300 L 750 300" class="wire-3v3"/>

  <!-- Wires: ESP32 to TB6612 Control Inputs -->
  <!-- AIN1 -->
  <path d="M 620 156 L 680 156 L 680 220 L 750 220" class="wire-signal"/>
  <!-- AIN2 -->
  <path d="M 620 176 L 670 176 L 670 235 L 750 235" class="wire-signal"/>
  <!-- BIN1 -->
  <path d="M 620 196 L 660 196 L 660 250 L 750 250" class="wire-signal"/>
  <!-- BIN2 -->
  <path d="M 620 216 L 650 216 L 650 265 L 750 265" class="wire-signal"/>
  <!-- STBY -->
  <path d="M 620 236 L 640 236 L 640 325 L 825 325" class="wire-signal"/>

  <!-- Wires: TB6612 to IAC -->
  <path d="M 900 185 L 950 185 L 950 185 L 1000 185" class="wire-motor"/>
  <path d="M 900 205 L 960 205 L 960 205 L 1000 205" class="wire-motor"/>
  <path d="M 900 235 L 950 235 L 950 240 L 1000 240" class="wire-motor"/>
  <path d="M 900 255 L 960 255 L 960 260 L 1000 260" class="wire-motor"/>

  <!-- ===== PCM CONNECTOR ===== -->
  <g transform="translate(40, 440)">
    <rect x="0" y="0" width="120" height="160" class="component-box-highlight"/>
    <text x="60" y="22" text-anchor="middle" class="component-label">PCM</text>
    <text x="60" y="42" text-anchor="middle" class="component-label">CONNECTOR</text>
    <text x="60" y="62" text-anchor="middle" class="note">(Original IAC plug)</text>
    
    <circle cx="120" cy="85" r="4" class="pin-dot"/>
    <text x="95" y="89" class="pin-label">A1</text>
    
    <circle cx="120" cy="105" r="4" class="pin-dot"/>
    <text x="95" y="109" class="pin-label">A2</text>
    
    <circle cx="120" cy="125" r="4" class="pin-dot"/>
    <text x="95" y="129" class="pin-label">B1</text>
    
    <circle cx="120" cy="145" r="4" class="pin-dot"/>
    <text x="95" y="149" class="pin-label">B2</text>
  </g>

  <!-- ===== PC817 OPTOCOUPLER (corrected for actual board) ===== -->
  <g transform="translate(250, 410)">
    <rect x="0" y="0" width="300" height="220" class="component-box"/>
    <text x="150" y="22" text-anchor="middle" class="component-label">PC817 8-CH OPTOCOUPLER</text>
    <text x="150" y="42" text-anchor="middle" class="note">(Using 4 of 8 channels)</text>
    
    <!-- Column headers -->
    <text x="45" y="65" text-anchor="middle" class="pin-label">INPUT</text>
    <text x="150" y="65" text-anchor="middle" class="pin-label">JUMPER</text>
    <text x="250" y="65" text-anchor="middle" class="pin-label">OUTPUT</text>
    
    <!-- Channel 1 -->
    <circle cx="0" cy="90" r="4" class="pin-dot"/>
    <text x="10" y="94" class="pin-label">IN1+</text>
    <circle cx="0" cy="105" r="4" class="pin-dot"/>
    <text x="10" y="109" class="pin-label">IN1-</text>
    <rect x="130" y="90" width="40" height="10" fill="#22c55e" rx="2"/>
    <text x="150" y="99" text-anchor="middle" style="font:9px monospace;fill:#0d1117">ON</text>
    <circle cx="300" cy="90" r="4" class="pin-dot"/>
    <text x="250" y="94" class="pin-label">OUT1+</text>
    <circle cx="300" cy="105" r="4" class="pin-dot"/>
    <text x="250" y="109" class="pin-label">OUT1-</text>
    
    <!-- Channel 2 -->
    <circle cx="0" cy="125" r="4" class="pin-dot"/>
    <text x="10" y="129" class="pin-label">IN2+</text>
    <circle cx="0" cy="140" r="4" class="pin-dot"/>
    <text x="10" y="144" class="pin-label">IN2-</text>
    <rect x="130" y="125" width="40" height="10" fill="#22c55e" rx="2"/>
    <text x="150" y="134" text-anchor="middle" style="font:9px monospace;fill:#0d1117">ON</text>
    <circle cx="300" cy="125" r="4" class="pin-dot"/>
    <text x="250" y="129" class="pin-label">OUT2+</text>
    <circle cx="300" cy="140" r="4" class="pin-dot"/>
    <text x="250" y="144" class="pin-label">OUT2-</text>
    
    <!-- Channel 3 -->
    <circle cx="0" cy="160" r="4" class="pin-dot"/>
    <text x="10" y="164" class="pin-label">IN3+</text>
    <circle cx="0" cy="175" r="4" class="pin-dot"/>
    <text x="10" y="179" class="pin-label">IN3-</text>
    <rect x="130" y="160" width="40" height="10" fill="#22c55e" rx="2"/>
    <text x="150" y="169" text-anchor="middle" style="font:9px monospace;fill:#0d1117">ON</text>
    <circle cx="300" cy="160" r="4" class="pin-dot"/>
    <text x="250" y="164" class="pin-label">OUT3+</text>
    <circle cx="300" cy="175" r="4" class="pin-dot"/>
    <text x="250" y="179" class="pin-label">OUT3-</text>
    
    <!-- Channel 4 -->
    <circle cx="0" cy="195" r="4" class="pin-dot"/>
    <text x="10" y="199" class="pin-label">IN4+</text>
    <circle cx="0" cy="210" r="4" class="pin-dot"/>
    <text x="10" y="214" class="pin-label">IN4-</text>
    <rect x="130" y="195" width="40" height="10" fill="#22c55e" rx="2"/>
    <text x="150" y="204" text-anchor="middle" style="font:9px monospace;fill:#0d1117">ON</text>
    <circle cx="300" cy="195" r="4" class="pin-dot"/>
    <text x="250" y="199" class="pin-label">OUT4+</text>
    <circle cx="300" cy="210" r="4" class="pin-dot"/>
    <text x="250" y="214" class="pin-label">OUT4-</text>
  </g>

  <!-- Wires: PCM to Optocoupler IN+ -->
  <path d="M 160 525 L 200 525 L 200 500 L 250 500" class="wire-pcm"/>
  <path d="M 160 545 L 210 545 L 210 535 L 250 535" class="wire-pcm"/>
  <path d="M 160 565 L 220 565 L 220 570 L 250 570" class="wire-pcm"/>
  <path d="M 160 585 L 230 585 L 230 605 L 250 605" class="wire-pcm"/>

  <!-- Wires: Optocoupler IN- all to ground -->
  <path d="M 250 515 L 220 515 L 220 680 L 340 680" class="wire-gnd"/>
  <path d="M 250 550 L 215 550 L 215 680" class="wire-gnd"/>
  <path d="M 250 585 L 210 585 L 210 680" class="wire-gnd"/>
  <path d="M 250 620 L 205 620 L 205 680" class="wire-gnd"/>

  <!-- Wires: Optocoupler OUT+ to ESP32 -->
  <path d="M 550 500 L 590 500 L 590 380 L 630 380 L 630 276" class="wire-signal"/>
  <path d="M 550 535 L 600 535 L 600 390 L 640 390 L 640 296" class="wire-signal"/>
  <path d="M 550 570 L 610 570 L 610 400 L 650 400 L 650 316" class="wire-signal"/>
  <path d="M 550 605 L 620 605 L 620 410 L 660 410 L 660 336" class="wire-signal"/>

  <!-- Wires: Optocoupler OUT- to ground (via jumpers) -->
  <path d="M 550 515 L 570 515 L 570 680 L 340 680" class="wire-gnd"/>
  <path d="M 550 550 L 575 550 L 575 680" class="wire-gnd"/>
  <path d="M 550 585 L 580 585 L 580 680" class="wire-gnd"/>
  <path d="M 550 620 L 585 620 L 585 680" class="wire-gnd"/>

  <!-- ===== PIN SUMMARY BOX ===== -->
  <g transform="translate(800, 420)">
    <rect x="0" y="0" width="300" height="280" class="component-box"/>
    <text x="150" y="25" text-anchor="middle" class="component-label">ESP32-S3 PIN SUMMARY</text>
    
    <text x="15" y="55" class="pin-label">MOTOR CONTROL:</text>
    <text x="25" y="75" class="note">GPIO7  &#8594; TB6612 AIN1</text>
    <text x="25" y="92" class="note">GPIO15 &#8594; TB6612 AIN2</text>
    <text x="25" y="109" class="note">GPIO6  &#8594; TB6612 BIN1</text>
    <text x="25" y="126" class="note">GPIO5  &#8594; TB6612 BIN2</text>
    <text x="25" y="143" class="note">GPIO18 &#8594; TB6612 STBY</text>
    
    <text x="15" y="170" class="pin-label">PCM MONITORING:</text>
    <text x="25" y="190" class="note">GPIO16 &#8592; PC817 OUT1+ (A1)</text>
    <text x="25" y="207" class="note">GPIO17 &#8592; PC817 OUT2+ (A2)</text>
    <text x="25" y="224" class="note">GPIO8  &#8592; PC817 OUT3+ (B1)</text>
    <text x="25" y="241" class="note">GPIO3  &#8592; PC817 OUT4+ (B2)</text>
    
    <text x="15" y="268" class="pin-label" style="fill:#a855f7">3.3V &#8594; TB6612 VCC, PWMA, PWMB</text>
  </g>

  <!-- ===== NOTES ===== -->
  <g transform="translate(40, 730)">
    <text x="0" y="0" class="component-label">IMPORTANT NOTES:</text>
    <text x="0" y="25" class="note">1. Set LM2596 output to 5V BEFORE connecting ESP32-S3</text>
    <text x="0" y="45" class="note">2. Install jumpers on PC817 channels 1-4 (connects OUT- to GND)</text>
    <text x="0" y="65" class="note">3. All IN- pins connect to common ground</text>
    <text x="500" y="25" class="note">4. ESP32 uses internal pull-ups (no external resistors needed)</text>
    <text x="500" y="45" class="note">5. Optocoupler INVERTS signals (code compensates)</text>
    <text x="500" y="65" class="note">6. 10uF capacitor: + to TB6612 VM, - to GND (smooths motor noise)</text>
    <text x="0" y="85" class="note" style="fill:#a855f7">7. PWMA and PWMB MUST be connected to 3.3V to enable motor outputs!</text>
  </g>

  <!-- ===== GROUND BUS ===== -->
  <line x1="50" y1="850" x2="1100" y2="850" class="wire-gnd" style="stroke-width:4"/>
  <text x="575" y="875" text-anchor="middle" class="pin-label">COMMON GROUND BUS</text>
  
  <!-- Ground connection dots -->
  <circle cx="100" cy="850" r="6" class="gnd-dot"/>
  <circle cx="290" cy="850" r="6" class="gnd-dot"/>
  <circle cx="480" cy="850" r="6" class="gnd-dot"/>
  <circle cx="800" cy="850" r="6" class="gnd-dot"/>
  <circle cx="340" cy="850" r="6" class="gnd-dot"/>

  <!-- Ground wires to bus -->
  <path d="M 100 190 L 100 850" class="wire-gnd"/>
  <path d="M 290 190 L 290 850" class="wire-gnd"/>
  <path d="M 480 185 L 480 850" class="wire-gnd"/>
  <path d="M 800 195 L 800 850" class="wire-gnd"/>
  <path d="M 340 680 L 340 850" class="wire-gnd"/>

</svg>
